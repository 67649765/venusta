import React, { useMemo, useState } from "react";
import { fetchDashboard, generateExam, gradeFirstItem, generateReview, runDiagnosis } from "./api";

export default function App() {
  const [paper, setPaper] = useState<{ paper_id: number; item_ids: number[] } | null>(null);
  const [grade, setGrade] = useState<any>(null);
  const [dash, setDash] = useState<any>(null);
  const [review, setReview] = useState<any>(null);
  const [diagnosis, setDiagnosis] = useState<any>(null);
  const [busy, setBusy] = useState<string>("");
  const [activeStep, setActiveStep] = useState<string>("");
  
  // è¡¨å•çŠ¶æ€
  const [showExamForm, setShowExamForm] = useState<boolean>(false);
  const [examFormData, setExamFormData] = useState({
    grade: "åˆä¸­",
    subject: "æ•°å­¦",
    chapter: "äºŒæ¬¡å‡½æ•°",
    knowledge_points: ["å›¾åƒæ€§è´¨"],
    item_type_ratio: { single_choice: 3, subjective: 2 },
    difficulty: 3,
    num_items: 5
  });
  
  // Toastæç¤ºçŠ¶æ€
  const [toast, setToast] = useState<{ show: boolean; message: string; type: 'error' | 'success' }>({
    show: false,
    message: "",
    type: 'error'
  });

  const firstItem = useMemo(() => paper?.item_ids?.[0], [paper]);

  // æ˜¾ç¤ºToastæç¤º
  const showToast = (message: string, type: 'error' | 'success' = 'error') => {
    setToast({ show: true, message, type });
    setTimeout(() => {
      setToast({ show: false, message: "", type: 'error' });
    }, 3000);
  };

  // å¤„ç†è¡¨å•å˜æ›´
  const handleFormChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    setExamFormData(prev => {
      if (name === 'num_items' || name === 'difficulty') {
        const n = parseInt(value, 10);
        return { ...prev, [name]: Number.isFinite(n) ? n : prev[name as 'num_items'|'difficulty'] };
      }
      return { ...prev, [name]: value };
    });
  };

  async function onGenerate() {
    try {
      setBusy("æ­£åœ¨ç”Ÿæˆè¯•å·â€¦");
      setActiveStep("generate");
      const res = await generateExam(examFormData);
      setPaper(res);
      setGrade(null);
      setDash(null);
      setReview(null);
      setDiagnosis(null);
      setShowExamForm(false);
      showToast("è¯•å·ç”ŸæˆæˆåŠŸï¼", 'success');
    } catch (e: any) {
      showToast(e.message);
    } finally {
      setBusy("");
      setActiveStep("");
    }
  }

  async function onGrade() {
    if (!paper || !firstItem) return showToast("è¯·å…ˆç”Ÿæˆè¯•å·");
    try {
      setBusy("æ­£åœ¨åˆ¤åˆ†â€¦");
      setActiveStep("grade");
      const res = await gradeFirstItem({
        user_id: 1,
        paper_id: paper.paper_id,
        item_id: firstItem,
        answer: "2"
      });
      setGrade(res);
      showToast("è¯„åˆ†å®Œæˆï¼", 'success');
    } catch (e: any) {
      showToast(e.message);
    } finally {
      setBusy("");
      setActiveStep("");
    }
  }

  async function onDashboard() {
    try {
      setBusy("åŠ è½½çœ‹æ¿æ•°æ®â€¦");
      setActiveStep("dashboard");
      const res = await fetchDashboard();
      setDash(res);
      showToast("çœ‹æ¿æ•°æ®åŠ è½½æˆåŠŸï¼", 'success');
    } catch (e: any) {
      showToast(e.message);
    } finally {
      setBusy("");
      setActiveStep("");
    }
  }

  async function onReview() {
    if (!paper) return showToast("è¯·å…ˆç”Ÿæˆè¯•å·");
    try {
      setBusy("ç”Ÿæˆè®²è¯„â€¦");
      setActiveStep("review");
      const data = await generateReview({ user_id: 1, paper_id: paper.paper_id });
      setReview(data);
      showToast("è®²è¯„ç”ŸæˆæˆåŠŸï¼", 'success');
    } catch (e: any) {
      showToast(e.message);
    } finally {
      setBusy("");
      setActiveStep("");
    }
  }

  async function onDiagnosis() {
    if (!paper) return showToast("è¯·å…ˆç”Ÿæˆè¯•å·");
    try {
      setBusy("è¯Šæ–­ä¸­â€¦");
      setActiveStep("diagnosis");
      const data = await runDiagnosis({ user_id: 1, paper_id: paper.paper_id });
      setDiagnosis(data);
      showToast("å­¦æƒ…è¯Šæ–­å®Œæˆï¼", 'success');
    } catch (e: any) {
      showToast(e.message);
      console.warn('æç¤ºï¼šè¯·ç¡®ä¿å·²å®Œæˆè¯„åˆ†æ­¥éª¤ï¼Œè¯Šæ–­éœ€è¦responsesè¡¨ä¸­çš„æ•°æ®');
    } finally {
      setBusy("");
      setActiveStep("");
    }
  }

  // æ¸²æŸ“è¿›åº¦æŒ‡ç¤ºå™¨
  const renderProgressIndicator = () => {
    const steps = [
      { id: 'generate', label: 'å‡ºé¢˜', completed: !!paper, active: activeStep === 'generate' },
      { id: 'grade', label: 'åˆ¤åˆ†', completed: !!grade, active: activeStep === 'grade' },
      { id: 'dashboard', label: 'çœ‹æ¿', completed: !!dash, active: activeStep === 'dashboard' },
      { id: 'review', label: 'è®²è¯„', completed: !!review, active: activeStep === 'review' },
      { id: 'diagnosis', label: 'è¯Šæ–­', completed: !!diagnosis, active: activeStep === 'diagnosis' }
    ];
    
    return (
      <div className="progress-indicator">
        {steps.map((step, index) => (
          <React.Fragment key={step.id}>
            <div className={`step ${step.completed ? 'completed' : ''} ${step.active ? 'active' : ''}`}>
              {step.completed ? (
                <span className="step-icon">âœ“</span>
              ) : (
                <span className="step-number">{index + 1}</span>
              )}
              <span className="step-label">{step.label}</span>
            </div>
            {index < steps.length - 1 && (
              <div className={`progress-line ${step.completed ? 'completed' : ''}`}></div>
            )}
          </React.Fragment>
        ))}
      </div>
    );
  };

  // å°å‹æ¡å½¢å›¾ç»„ä»¶
  const BarChart = ({ data, maxValue = 100 }) => {
    return (
      <div className="bar-chart">
        {Object.entries(data || {}).map(([key, value]) => {
          const percentage = Math.min((Number(value) / maxValue) * 100, 100);
          return (
            <div key={key} className="chart-item">
              <div className="chart-label">{key}</div>
              <div className="chart-bar-container">
                <div 
                  className="chart-bar" 
                  style={{ width: `${percentage}%` }}
                ></div>
              </div>
              <div className="chart-value">{value}</div>
            </div>
          );
        })}
      </div>
    );
  };

  // å°å‹é¥¼å›¾ç»„ä»¶ï¼ˆç®€åŒ–ç‰ˆï¼‰
  const PieChart = ({ data }) => {
    const colors = ['#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2', '#073B4C'];
    
    if (!data || Object.keys(data).length === 0) return null;
    
    return (
      <div className="pie-chart">
        {Object.entries(data).map(([key, value], index) => (
          <div key={key} className="pie-item">
            <div 
              className="pie-color" 
              style={{ backgroundColor: colors[index % colors.length] }}
            ></div>
            <div className="pie-label">{key}</div>
            <div className="pie-value">{value}</div>
          </div>
        ))}
      </div>
    );
  };

  return (
    <div className="app-container">
      <header className="app-header">
        <div className="header-content">
          <h1>VenusTA æ•™å¸ˆå·¥ä½œå°</h1>
          <p className="header-subtitle">
            {busy || 'æ™ºèƒ½è¾…åŠ©æ•™å­¦å¹³å°ï¼Œæå‡æ•™å­¦æ•ˆç‡'}
          </p>
        </div>
      </header>
      
      {/* è¿›åº¦æŒ‡ç¤ºå™¨ */}
      {renderProgressIndicator()}
      
      {/* æ“ä½œæŒ‰é’®åŒºåŸŸ */}
      <div className="action-buttons">
        {!showExamForm ? (
          <button 
              className={`action-btn ${activeStep === 'generate' ? 'active' : ''}`}
              onClick={() => setShowExamForm(true)}
              disabled={activeStep === 'generate'}
            >
              {activeStep === 'generate' ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆè¯•å·'}
            </button>
        ) : (
          <div className="exam-form">
            <h3>é…ç½®è¯•å·å‚æ•°</h3>
            <div className="form-row">
              <div className="form-group">
                <label>å¹´çº§</label>
                <select name="grade" value={examFormData.grade} onChange={handleFormChange}>
                  <option value="å°å­¦">å°å­¦</option>
                  <option value="åˆä¸­">åˆä¸­</option>
                  <option value="é«˜ä¸­">é«˜ä¸­</option>
                </select>
              </div>
              <div className="form-group">
                <label>ç§‘ç›®</label>
                <select name="subject" value={examFormData.subject} onChange={handleFormChange}>
                  <option value="æ•°å­¦">æ•°å­¦</option>
                  <option value="è¯­æ–‡">è¯­æ–‡</option>
                  <option value="è‹±è¯­">è‹±è¯­</option>
                </select>
              </div>
              <div className="form-group">
                <label>ç« èŠ‚</label>
                <input 
                  type="text" 
                  name="chapter" 
                  value={examFormData.chapter} 
                  onChange={handleFormChange}
                />
              </div>
            </div>
            <div className="form-row">
              <div className="form-group">
                <label>éš¾åº¦ (1-5)</label>
                <input 
                  type="number" 
                  name="difficulty" 
                  min="1" 
                  max="5" 
                  value={examFormData.difficulty} 
                  onChange={handleFormChange}
                />
              </div>
              <div className="form-group">
                <label>é¢˜é‡</label>
                <input 
                  type="number" 
                  name="num_items" 
                  min="1" 
                  max="20" 
                  value={examFormData.num_items} 
                  onChange={handleFormChange}
                />
              </div>
            </div>
            <div className="form-actions">
              <button className="submit-btn" onClick={onGenerate} disabled={activeStep === 'generate'}>
                {activeStep === 'generate' ? 'ç”Ÿæˆä¸­...' : 'ç¡®è®¤ç”Ÿæˆ'}
              </button>
              <button className="cancel-btn" onClick={() => setShowExamForm(false)}>å–æ¶ˆ</button>
            </div>
          </div>
        )}
        <button 
          className={`action-btn ${activeStep === 'grade' ? 'active' : ''}`}
          onClick={onGrade}
          disabled={!paper || !!activeStep}
        >
          {activeStep === 'grade' ? 'è¯„åˆ†ä¸­...' : 'åˆ¤åˆ†'}
        </button>
        <button 
          className={`action-btn ${activeStep === 'dashboard' ? 'active' : ''}`}
          onClick={onDashboard}
          disabled={!!activeStep}
        >
          {activeStep === 'dashboard' ? 'åŠ è½½ä¸­...' : 'æŸ¥çœ‹çœ‹æ¿'}
        </button>
        <button 
          className={`action-btn ${activeStep === 'review' ? 'active' : ''}`}
          onClick={onReview}
          disabled={!paper || !!activeStep}
        >
          {activeStep === 'review' ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆè®²è¯„'}
        </button>
        <button 
          className={`action-btn ${activeStep === 'diagnosis' ? 'active' : ''}`}
          onClick={onDiagnosis}
          disabled={!paper || !!activeStep}
        >
          {activeStep === 'diagnosis' ? 'è¯Šæ–­ä¸­...' : 'å­¦æƒ…è¯Šæ–­'}
        </button>
      </div>
      
      {/* æ•°æ®å¡ç‰‡åŒºåŸŸ */}
      <div className="data-cards">
        {/* è¯•å·ä¿¡æ¯å¡ç‰‡ */}
        {paper && (
          <div className="data-card paper-card">
            <div className="card-header">
              <h3>ğŸ“ è¯•å·ä¿¡æ¯</h3>
              <button className="close-btn" onClick={() => setPaper(null)}>Ã—</button>
            </div>
            <div className="card-body">
              <p><strong>è¯•å·ID:</strong> {paper.paper_id}</p>
              <p><strong>è¯•é¢˜æ•°é‡:</strong> {paper.item_ids.length}</p>
              <p><strong>è¯•é¢˜IDåˆ—è¡¨:</strong> {paper.item_ids.join(', ')}</p>
            </div>
          </div>
        )}

        {/* è¯„åˆ†ç»“æœå¡ç‰‡ */}
        {grade && (
          <div className="data-card grade-card">
            <div className="card-header">
              <h3>âœï¸ è¯„åˆ†ç»“æœ</h3>
              <button className="close-btn" onClick={() => setGrade(null)}>Ã—</button>
            </div>
            <div className="card-body">
              <div className="score-display">
                <span className="score-value">{grade.score}</span>
                <span className="score-max">/ 100</span>
              </div>
              {grade.judge_meta && (
                <div className="judge-meta">
                  <p><strong>è¯„åˆ†ä¾æ®:</strong> {grade.judge_meta.reason || 'è‡ªåŠ¨è¯„åˆ†'}</p>
                  {grade.judge_meta.confidence && (
                    <p><strong>ç½®ä¿¡åº¦:</strong> {Math.round(grade.judge_meta.confidence * 100)}%</p>
                  )}
                </div>
              )}
            </div>
          </div>
        )}

        {/* çœ‹æ¿æ•°æ®å¡ç‰‡ */}
        {dash && (
          <div className="data-card dashboard-card">
            <div className="card-header">
              <h3>ğŸ“Š æ•™å­¦çœ‹æ¿</h3>
              <button className="close-btn" onClick={() => setDash(null)}>Ã—</button>
            </div>
            <div className="card-body">
              <div className="metrics-grid">
                <div className="metric-item">
                  <span className="metric-label">æ€»å“åº”æ•°</span>
                  <span className="metric-value">{dash.responses ?? 0}</span>
                </div>
                <div className="metric-item">
                  <span className="metric-label">Kappaç³»æ•°</span>
                  <span className="metric-value">{dash.kappa != null ? dash.kappa.toFixed(2) : 'N/A'}</span>
                </div>
                <div className="metric-item">
                  <span className="metric-label">MAE</span>
                  <span className="metric-value">{dash.mae != null ? dash.mae.toFixed(2) : 'N/A'}</span>
                </div>
                <div className="metric-item">
                  <span className="metric-label">æ»¡æ„åº¦</span>
                  <span className="metric-value">{dash.satisfaction != null ? dash.satisfaction.toFixed(1) : 'N/A'}</span>
                </div>
              </div>
              <div className="dashboard-chart">
                <BarChart 
                  data={{
                    'å“åº”æ•°': dash.responses || 0
                  }}
                  maxValue={50}
                />
              </div>
            </div>
          </div>
        )}

        {/* è®²è¯„ç»“æœå¡ç‰‡ */}
        {review && (
          <div className="data-card review-card">
            <div className="card-header">
              <h3>ğŸ“š è¯•å·è®²è¯„</h3>
              <button className="close-btn" onClick={() => setReview(null)}>Ã—</button>
            </div>
            <div className="card-body">
              <div className="review-summary">
                <h4>æ ¸å¿ƒæ€»ç»“</h4>
                <p>{review.summary}</p>
              </div>
              {review.cards && (
                <div className="review-cards">
                  <h4>çŸ¥è¯†ç‚¹åˆ†æ</h4>
                  {review.cards.map((card: any, index: number) => {
                    const title = card.knowledge_point ?? card.type ?? `è¦ç‚¹ ${index + 1}`;
                    const difficulty = card.difficulty ?? '-';
                    const text = card.analysis ?? card.content ?? '';
                    return (
                      <div key={index} className="knowledge-card">
                        <div className="knowledge-card-header">
                          <span className="knowledge-title">{title}</span>
                          <span className="knowledge-difficulty">éš¾åº¦: {difficulty}</span>
                        </div>
                        <p className="knowledge-analysis">{text}</p>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        )}

        {/* è¯Šæ–­ç»“æœå¡ç‰‡ */}
        {diagnosis && (
          <div className="data-card diagnosis-card">
            <div className="card-header">
              <h3>ğŸ” å­¦æƒ…è¯Šæ–­</h3>
              <button className="close-btn" onClick={() => setDiagnosis(null)}>Ã—</button>
            </div>
            <div className="card-body">
              {diagnosis.heatmap && (
                <div className="diagnosis-heatmap">
                  <h4>çŸ¥è¯†ç‚¹æŒæ¡çƒ­åº¦å›¾</h4>
                  <div className="heatmap-grid">
                    {Object.entries(diagnosis.heatmap).slice(0, 5).map(([point, value]) => (
                      <div key={point} className="heatmap-item">
                        <span className="heatmap-label">{point}</span>
                        <div className="heatmap-bar-container">
                          <div 
                            className="heatmap-bar" 
                            style={{ 
                              width: `${value * 100}%`,
                              backgroundColor: `rgba(255, 99, 132, ${value})`
                            }}
                          ></div>
                        </div>
                        <span className="heatmap-value">{Math.round(value * 100)}%</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}
              
              {diagnosis.error_dist && (
                <div className="diagnosis-error">
                  <h4>é”™è¯¯åˆ†å¸ƒ</h4>
                  <PieChart data={diagnosis.error_dist} />
                </div>
              )}
              
              {diagnosis.recommendations && (
                <div className="diagnosis-recommendations">
                  <h4>æ•™å­¦å»ºè®®</h4>
                  <ul>
                    {(() => {
                      const recObj = diagnosis.recommendations;
                      const list = Array.isArray(recObj)
                        ? recObj
                        : Object.entries(recObj).flatMap(([cat, items]: [string, any]) =>
                            Array.isArray(items) ? items.map((x: any) => `${cat}: ${x}`) : [`${cat}: ${String(items)}`]
                          );
                      return list.slice(0, 6).map((t: string, i: number) => <li key={i}>{t}</li>);
                    })()}
                  </ul>
                </div>
              )}
            </div>
          </div>
        )}
      </div>
      
      {/* ç©ºçŠ¶æ€æç¤º */}
      {!paper && !grade && !dash && !review && !diagnosis && !busy && (
        <div className="empty-state">
          <div className="empty-state-icon">ğŸ“</div>
          <h3>æ¬¢è¿ä½¿ç”¨ VenusTA æ•™å¸ˆå·¥ä½œå°</h3>
          <p>è¯·ç‚¹å‡»ä¸Šæ–¹çš„ã€Œç”Ÿæˆè¯•å·ã€æŒ‰é’®å¼€å§‹æ‚¨çš„æ•™å­¦å·¥ä½œæµç¨‹</p>
          <p className="empty-state-hint">å»ºè®®æµç¨‹ï¼šå‡ºé¢˜ â†’ åˆ¤åˆ† â†’ æŸ¥çœ‹çœ‹æ¿ â†’ ç”Ÿæˆè®²è¯„ â†’ è¿›è¡Œè¯Šæ–­</p>
        </div>
      )}
      
      {/* Toastæç¤ºç»„ä»¶ */}
      {toast.show && (
        <div className={`toast toast-${toast.type}`}>
          <span className="toast-icon">
            {toast.type === 'success' ? 'âœ…' : 'âŒ'}
          </span>
          <span className="toast-message">{toast.message}</span>
        </div>
      )}
    </div>
  );
}